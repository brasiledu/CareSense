{% extends 'base.html' %}

{% block title %}Teste Digit Span - {{ assessment.patient.full_name }} - AvivaMente{% endblock %}

{% block content %}
<div class="card">
    <h1><i class="fas fa-list-ol"></i> Teste Digit Span (WAIS-IV)</h1>
    <div style="background: #e8f4f8; padding: 1rem; border-radius: 4px; margin: 1rem 0;">
        <strong><i class="fas fa-user"></i> Paciente:</strong> {{ assessment.patient.full_name }} ({{ assessment.patient.age }} anos)<br>
        <strong><i class="fas fa-graduation-cap"></i> Escolaridade:</strong> {{ assessment.patient.education_level }} anos<br>
        <strong><i class="fas fa-brain"></i> Objetivo:</strong> Avaliação da memória de trabalho e atenção<br>
        <strong><i class="fas fa-clipboard"></i> Avaliação ID:</strong> {{ assessment.id }}
    </div>
</div>

<!-- Instruções -->
<div class="card">
    <h2><i class="fas fa-info-circle"></i> Instruções Padronizadas</h2>
    
    <div style="background: #fff3cd; padding: 1.5rem; border-radius: 8px; margin: 1rem 0; border-left: 4px solid #ffc107;">
        <h3><i class="fas fa-arrow-right"></i> SPAN DIRETO:</h3>
        <p><strong>Instrução:</strong> "Vou dizer alguns números. Escute com atenção e repita os números na mesma ordem que eu disser."</p>
        <p><strong>Exemplo:</strong> "Se eu disser 7-1-9, você deve repetir 7-1-9."</p>
        
        <h3><i class="fas fa-arrow-left"></i> SPAN INVERSO:</h3>
        <p><strong>Instrução:</strong> "Agora vou dizer outros números, mas desta vez quero que você os repita na ordem inversa, de trás para frente."</p>
        <p><strong>Exemplo:</strong> "Se eu disser 3-8-4, você deve repetir 4-8-3."</p>
    </div>
    
    <div style="background: #d1ecf1; padding: 1rem; border-radius: 4px; margin: 1rem 0;">
        <h4><i class="fas fa-exclamation-triangle"></i> Critérios de Aplicação:</h4>
        <ul>
            <li>Apresentar cada dígito a 1 segundo de intervalo</li>
            <li>Duas tentativas por nível de dificuldade</li>
            <li>Parar quando o paciente falha nas duas tentativas do mesmo nível</li>
            <li>Começar sempre com sequências de 2 dígitos</li>
            <li>Máximo de 9 dígitos para span direto, 8 para span inverso</li>
        </ul>
    </div>
</div>

<!-- Interface do Teste -->
<div class="card">
    <h2><i class="fas fa-play-circle"></i> Aplicação do Teste</h2>
    
    <div id="test-area">
        <div id="instructions-panel" style="background: #f8f9fa; padding: 2rem; border-radius: 8px; text-align: center;">
            <h3>Pronto para começar?</h3>
            <p>Clique no botão abaixo para iniciar o teste interativo</p>
            <button id="start-button" class="btn btn-success" style="font-size: 1.2rem; padding: 1rem 2rem;">
                <i class="fas fa-play"></i> Iniciar Teste Span Direto
            </button>
        </div>
        
        <div id="presentation-area" style="display: none; text-align: center; margin: 2rem 0;">
            <h3 id="current-phase">Span Direto - Sequência de 2 dígitos</h3>
            
            <div id="sequence-display" style="font-size: 4rem; font-weight: bold; color: #2c3e50; margin: 2rem 0; min-height: 120px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 8px; border: 2px solid #dee2e6;">
                Preparando...
            </div>
            
            <div id="instruction-text" style="font-size: 1.1rem; color: #495057; margin: 1rem 0; background: #e9ecef; padding: 1rem; border-radius: 4px;">
                O paciente deve repetir os números na mesma ordem
            </div>
            
            <div id="control-buttons" style="margin: 2rem 0;">
                <button id="correct-btn" class="btn btn-success" style="margin: 0.5rem; padding: 1rem 1.5rem;">
                    <i class="fas fa-check"></i> Correto
                </button>
                <button id="incorrect-btn" class="btn btn-danger" style="margin: 0.5rem; padding: 1rem 1.5rem;">
                    <i class="fas fa-times"></i> Incorreto
                </button>
                <button id="repeat-btn" class="btn btn-warning" style="margin: 0.5rem; padding: 1rem 1.5rem;">
                    <i class="fas fa-redo"></i> Repetir
                </button>
            </div>
            
            <div id="progress-info" style="background: #e3f2fd; padding: 1rem; border-radius: 4px; margin: 1rem 0;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div><strong>Fase:</strong> <span id="phase-text">Span Direto</span></div>
                    <div><strong>Nível:</strong> <span id="level-text">2 dígitos</span></div>
                    <div><strong>Tentativa:</strong> <span id="attempt-text">1 de 2</span></div>
                    <div><strong>Pontuação:</strong> <span id="score-text">0</span></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Formulário de Resultados -->
<form method="POST" id="results-form" class="card" style="display: none;">
    {% csrf_token %}
    <h2><i class="fas fa-calculator"></i> Resultados do Teste</h2>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
        <div style="background: #e3f2fd; padding: 1.5rem; border-radius: 8px;">
            <h3><i class="fas fa-arrow-right"></i> Span Direto</h3>
            <div style="margin: 1rem 0;">
                <label for="forward_score" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                    <i class="fas fa-star"></i> Pontuação Total:
                </label>
                <input type="number" name="forward_score" id="forward_score" min="0" max="16" required 
                       style="width: 100%; padding: 0.75rem; border: 2px solid #2196f3; border-radius: 4px; font-size: 1rem;">
                <small style="color: #1976d2;">Soma de sequências corretas (0-16 pontos)</small>
            </div>
            
            <div style="margin: 1rem 0;">
                <label for="forward_span" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                    <i class="fas fa-trophy"></i> Span Máximo:
                </label>
                <input type="number" name="forward_span" id="forward_span" min="0" max="9" required 
                       style="width: 100%; padding: 0.75rem; border: 2px solid #2196f3; border-radius: 4px; font-size: 1rem;">
                <small style="color: #1976d2;">Maior sequência correta (2-9 dígitos)</small>
            </div>
        </div>
        
        <div style="background: #fce4ec; padding: 1.5rem; border-radius: 8px;">
            <h3><i class="fas fa-arrow-left"></i> Span Inverso</h3>
            <div style="margin: 1rem 0;">
                <label for="backward_score" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                    <i class="fas fa-star"></i> Pontuação Total:
                </label>
                <input type="number" name="backward_score" id="backward_score" min="0" max="14" required 
                       style="width: 100%; padding: 0.75rem; border: 2px solid #e91e63; border-radius: 4px; font-size: 1rem;">
                <small style="color: #c2185b;">Soma de sequências corretas (0-14 pontos)</small>
            </div>
            
            <div style="margin: 1rem 0;">
                <label for="backward_span" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                    <i class="fas fa-trophy"></i> Span Máximo:
                </label>
                <input type="number" name="backward_span" id="backward_span" min="0" max="8" required 
                       style="width: 100%; padding: 0.75rem; border: 2px solid #e91e63; border-radius: 4px; font-size: 1rem;">
                <small style="color: #c2185b;">Maior sequência correta (2-8 dígitos)</small>
            </div>
        </div>
    </div>
    
    <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin: 2rem 0; text-align: center;">
        <h4><i class="fas fa-calculator"></i> Pontuação Total: <span id="total-score">0</span> pontos</h4>
    </div>
    
    <div style="margin: 2rem 0; text-align: center;">
        <button type="submit" class="btn btn-success" style="font-size: 1.1rem; padding: 1rem 2rem;">
            <i class="fas fa-save"></i> Salvar Resultados
        </button>
        <a href="{% url 'run_tests' assessment.id %}" class="btn" style="margin-left: 1rem;">
            <i class="fas fa-arrow-left"></i> Voltar aos Testes
        </a>
    </div>
</form>

<script>
// Teste Digit Span Simplificado
class SimpleDigitSpanTest {
    constructor() {
        this.currentPhase = 'forward';
        this.currentLevel = 2;
        this.currentAttempt = 1;
        this.forwardScore = 0;
        this.backwardScore = 0;
        this.forwardSpan = 0;
        this.backwardSpan = 0;
        this.consecutiveErrors = 0;
        
        this.sequences = {
            forward: {
                2: ['5-8', '6-9'],
                3: ['5-8-2', '6-9-4'],
                4: ['6-4-3-9', '7-2-8-6'],
                5: ['4-2-7-3-1', '7-5-8-3-6'],
                6: ['6-1-9-4-7-3', '3-9-2-4-8-7'],
                7: ['5-9-1-7-4-2-8', '4-1-7-9-3-8-6'],
                8: ['5-8-1-9-2-6-4-7', '3-8-2-9-5-1-7-4'],
                9: ['2-7-5-8-6-2-5-8-4', '7-1-3-9-4-2-5-6-8']
            },
            backward: {
                2: ['2-4', '5-7'],
                3: ['6-2-9', '4-1-5'],
                4: ['3-2-7-9', '4-9-6-8'],
                5: ['1-5-2-8-6', '6-1-8-4-3'],
                6: ['5-3-9-4-1-8', '7-2-4-8-5-6'],
                7: ['8-1-2-9-3-6-5', '4-7-3-9-1-2-8'],
                8: ['9-4-3-7-6-2-5-8', '7-2-8-1-9-6-5-3']
            }
        };
        
        this.initializeEventListeners();
    }
    
    initializeEventListeners() {
        document.getElementById('start-button').addEventListener('click', () => this.startTest());
        document.getElementById('correct-btn').addEventListener('click', () => this.handleCorrect());
        document.getElementById('incorrect-btn').addEventListener('click', () => this.handleIncorrect());
        document.getElementById('repeat-btn').addEventListener('click', () => this.repeatSequence());
        
        // Auto-calcular pontuação total
        ['forward_score', 'backward_score'].forEach(id => {
            document.getElementById(id).addEventListener('input', () => this.calculateTotal());
        });
    }
    
    startTest() {
        document.getElementById('instructions-panel').style.display = 'none';
        document.getElementById('presentation-area').style.display = 'block';
        this.presentSequence();
    }
    
    presentSequence() {
        this.updateDisplay();
        
        const sequences = this.sequences[this.currentPhase][this.currentLevel];
        if (!sequences || this.currentAttempt > sequences.length) {
            this.nextLevel();
            return;
        }
        
        const sequence = sequences[this.currentAttempt - 1];
        this.showSequence(sequence);
    }
    
    showSequence(sequence) {
        const display = document.getElementById('sequence-display');
        const digits = sequence.split('-');
        
        display.textContent = 'Preparando...';
        display.style.background = '#f8f9fa';
        
        setTimeout(() => {
            let index = 0;
            const showDigit = () => {
                if (index < digits.length) {
                    display.textContent = digits[index];
                    display.style.background = '#e8f5e8';
                    index++;
                    setTimeout(showDigit, 1000);
                } else {
                    display.textContent = 'Aguardando resposta...';
                    display.style.background = '#fff3cd';
                }
            };
            showDigit();
        }, 1000);
    }
    
    handleCorrect() {
        if (this.currentPhase === 'forward') {
            this.forwardScore++;
            this.forwardSpan = Math.max(this.forwardSpan, this.currentLevel);
        } else {
            this.backwardScore++;
            this.backwardSpan = Math.max(this.backwardSpan, this.currentLevel);
        }
        
        this.consecutiveErrors = 0;
        this.currentAttempt++;
        this.presentSequence();
    }
    
    handleIncorrect() {
        this.consecutiveErrors++;
        this.currentAttempt++;
        
        if (this.consecutiveErrors >= 2) {
            this.nextLevel();
        } else {
            this.presentSequence();
        }
    }
    
    nextLevel() {
        this.consecutiveErrors = 0;
        this.currentAttempt = 1;
        this.currentLevel++;
        
        if (this.currentPhase === 'forward' && this.currentLevel > 9) {
            this.currentPhase = 'backward';
            this.currentLevel = 2;
            document.getElementById('instruction-text').textContent = 
                'O paciente deve repetir os números na ordem INVERSA';
        } else if (this.currentPhase === 'backward' && this.currentLevel > 8) {
            this.finishTest();
            return;
        }
        
        this.presentSequence();
    }
    
    repeatSequence() {
        this.presentSequence();
    }
    
    updateDisplay() {
        document.getElementById('phase-text').textContent = 
            this.currentPhase === 'forward' ? 'Span Direto' : 'Span Inverso';
        document.getElementById('level-text').textContent = `${this.currentLevel} dígitos`;
        document.getElementById('attempt-text').textContent = `${this.currentAttempt} de 2`;
        document.getElementById('score-text').textContent = 
            this.currentPhase === 'forward' ? this.forwardScore : this.backwardScore;
        document.getElementById('current-phase').textContent = 
            `${this.currentPhase === 'forward' ? 'Span Direto' : 'Span Inverso'} - Sequência de ${this.currentLevel} dígitos`;
    }
    
    finishTest() {
        document.getElementById('presentation-area').style.display = 'none';
        document.getElementById('results-form').style.display = 'block';
        
        document.getElementById('forward_score').value = this.forwardScore;
        document.getElementById('forward_span').value = this.forwardSpan;
        document.getElementById('backward_score').value = this.backwardScore;
        document.getElementById('backward_span').value = this.backwardSpan;
        
        this.calculateTotal();
    }
    
    calculateTotal() {
        const forward = parseInt(document.getElementById('forward_score').value) || 0;
        const backward = parseInt(document.getElementById('backward_score').value) || 0;
        document.getElementById('total-score').textContent = forward + backward;
    }
}

// Inicializar quando a página carregar
document.addEventListener('DOMContentLoaded', function() {
    new SimpleDigitSpanTest();
});
</script>

<style>
.btn {
    transition: all 0.3s ease;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

#sequence-display {
    transition: all 0.5s ease;
}

.card {
    margin-bottom: 2rem;
}
</style>
{% endblock %}
