{% extends 'base.html' %}

{% block title %}Teste Digit Span - {{ assessment.patient.full_name }} - CareSense{% endblock %}

{% block content %}
<div class="card">
    <h1><i class="fas fa-list-ol"></i> Teste Digit Span</h1>
    <div style="background: #e8f4f8; padding: 1rem; border-radius: 4px; margin: 1rem 0;">
        <strong><i class="fas fa-user"></i> Paciente:</strong> {{ assessment.patient.full_name }} ({{ assessment.patient.age }} anos)<br>
        <strong><i class="fas fa-target"></i> Teste:</strong> Avalia√ß√£o da mem√≥ria de trabalho e aten√ß√£o
    </div>
</div>

<!-- Interface do Teste Interativo -->
<div id="testInterface" class="card" style="display: none;">
    <div id="testHeader" style="text-align: center; margin-bottom: 2rem;">
        <h2 id="currentTest">Digit Span - Ordem Direta</h2>
        <div id="sequenceDisplay" style="font-size: 2rem; font-weight: bold; color: #2c3e50; margin: 1rem 0; min-height: 60px; display: flex; align-items: center; justify-content: center;">
            Pressione INICIAR para come√ßar
        </div>
        <div id="instructionText" style="background: #e8f4f8; padding: 1rem; border-radius: 4px; margin: 1rem 0;">
            Ou√ßa a sequ√™ncia de n√∫meros e repita na mesma ordem
        </div>
    </div>

    <!-- Campo de entrada para resposta -->
    <div style="text-align: center; margin: 2rem 0;">
        <input type="text" id="digitInput" placeholder="Digite os n√∫meros (ex: 1 2 3)" 
               style="font-size: 1.5rem; padding: 1rem; border: 2px solid #3498db; border-radius: 8px; width: 300px; text-align: center;" disabled>
    </div>

    <div id="testControls" style="text-align: center; margin: 2rem 0;">
        <button id="startBtn" onclick="startDigitSpan()" class="btn btn-success" style="font-size: 1.2rem; padding: 1rem 2rem;">
            ‚ñ∂Ô∏è INICIAR TESTE
        </button>
        <button id="playBtn" onclick="playSequence()" class="btn btn-primary" style="display: none; margin-left: 1rem;">
            üîä Reproduzir Sequ√™ncia
        </button>
        <button id="submitBtn" onclick="submitAnswer()" class="btn btn-warning" style="display: none; margin-left: 1rem;">
            ‚úÖ Enviar Resposta
        </button>
        <button id="nextBtn" onclick="nextTrial()" class="btn btn-info" style="display: none; margin-left: 1rem;">
            ‚û°Ô∏è Pr√≥xima
        </button>
        <button id="reverseBtn" onclick="startReverse()" class="btn btn-primary" style="display: none; margin-left: 1rem;">
            üîÑ Ordem Reversa
        </button>
        <button id="finishBtn" onclick="finishDigitSpan()" class="btn btn-success" style="display: none; margin-left: 1rem;">
            Finalizar
        </button>
    </div>

    <div id="trialInfo" style="text-align: center; margin: 1rem 0; font-weight: bold;"></div>
    <div id="feedback" style="text-align: center; margin: 1rem 0; font-weight: bold;"></div>
</div>

<!-- Instru√ß√µes Iniciais -->
<div id="instructionsCard" class="card">
    <h2><i class="fas fa-info-circle"></i> Instru√ß√µes</h2>
    <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 4px; margin-bottom: 2rem;">
        <h4>Ordem Direta:</h4>
        <p>O paciente deve repetir uma sequ√™ncia de n√∫meros na mesma ordem que foram apresentados.</p>
        <p style="color: #e67e22;"><strong>Exemplo:</strong> Sequ√™ncia: "2 - 8 - 3" ‚Üí Resposta: "2 8 3"</p>
        
        <h4 style="margin-top: 1.5rem;">Ordem Reversa:</h4>
        <p>O paciente deve repetir uma sequ√™ncia de n√∫meros na ordem inversa.</p>
        <p style="color: #e67e22;"><strong>Exemplo:</strong> Sequ√™ncia: "2 - 8 - 3" ‚Üí Resposta: "3 8 2"</p>
        
        <p style="color: #e74c3c;"><strong>‚ö†Ô∏è Importante:</strong> O teste termina ap√≥s 2 erros consecutivos na mesma fase.</p>
    </div>
    
    <div style="text-align: center;">
        <button onclick="showTestInterface()" class="btn btn-primary" style="font-size: 1.2rem; padding: 1rem 2rem;">
            <i class="fas fa-rocket"></i> Come√ßar Teste Interativo
        </button>
    </div>
</div>

<!-- Formul√°rio de Resultados -->
<form method="POST" id="resultsForm" class="card" style="display: none;">
    {% csrf_token %}
    <h2><i class="fas fa-save"></i> Resultados do Teste</h2>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin: 2rem 0;">
        <!-- Ordem Direta -->
        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px;">
            <h3><i class="fas fa-arrow-right"></i> Ordem Direta</h3>
            
            <div style="margin: 1rem 0;">
                <label for="direct_span" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                    <i class="fas fa-list-ol"></i> Maior Sequ√™ncia Correta:
                </label>
                <input type="number" id="direct_span" name="direct_span" min="0" max="15" required
                       style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;" readonly>
                <small style="color: #666;">Registrado automaticamente</small>
            </div>
            
            <div style="margin: 1rem 0;">
                <label for="direct_total" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                    <i class="fas fa-check"></i> Total de Acertos:
                </label>
                <input type="number" id="direct_total" name="direct_total" min="0" max="30" required
                       style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;" readonly>
                <small style="color: #666;">Registrado automaticamente</small>
            </div>
        </div>

        <!-- Ordem Reversa -->
        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px;">
            <h3><i class="fas fa-arrow-left"></i> Ordem Reversa</h3>
            
            <div style="margin: 1rem 0;">
                <label for="reverse_span" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                    <i class="fas fa-list-ol"></i> Maior Sequ√™ncia Correta:
                </label>
                <input type="number" id="reverse_span" name="reverse_span" min="0" max="15" required
                       style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;" readonly>
                <small style="color: #666;">Registrado automaticamente</small>
            </div>
            
            <div style="margin: 1rem 0;">
                <label for="reverse_total" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                    <i class="fas fa-check"></i> Total de Acertos:
                </label>
                <input type="number" id="reverse_total" name="reverse_total" min="0" max="30" required
                       style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;" readonly>
                <small style="color: #666;">Registrado automaticamente</small>
            </div>
        </div>
    </div>

    <div style="margin: 2rem 0; text-align: center;">
        <button type="submit" class="btn btn-success" style="font-size: 1.1rem; padding: 1rem 2rem;">
            <i class="fas fa-save"></i> Salvar Resultados
        </button>
        <a href="{% url 'run_tests' assessment.id %}" class="btn" style="margin-left: 1rem;">
            <i class="fas fa-arrow-left"></i> Voltar aos Testes
        </a>
    </div>
</form>

<div class="card">
    <h2><i class="fas fa-ruler"></i> Valores de Refer√™ncia</h2>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
        <div>
            <h4>Digit Span Direto - Valores Normais:</h4>
            <ul style="line-height: 1.8;">
                <li><strong>Adultos (m√©dia):</strong> 6-7 d√≠gitos</li>
                <li><strong>Limite inferior:</strong> 5 d√≠gitos</li>
                <li><strong>Superior:</strong> 8-9 d√≠gitos</li>
                <li><strong>Idosos:</strong> 5-6 d√≠gitos</li>
            </ul>
        </div>
        <div>
            <h4>Digit Span Reverso - Valores Normais:</h4>
            <ul style="line-height: 1.8;">
                <li><strong>Adultos (m√©dia):</strong> 4-5 d√≠gitos</li>
                <li><strong>Limite inferior:</strong> 3 d√≠gitos</li>
                <li><strong>Superior:</strong> 6-7 d√≠gitos</li>
                <li><strong>Idosos:</strong> 3-4 d√≠gitos</li>
            </ul>
        </div>
    </div>
    
    <div style="background: #fff3cd; padding: 1rem; border-radius: 4px; margin-top: 1rem;">
        <strong><i class="fas fa-lightbulb"></i> Dica de Aplica√ß√£o:</strong>
        O teste apresenta as sequ√™ncias com intervalos de 1 segundo entre os n√∫meros. Use fones de ouvido se dispon√≠vel.
    </div>
    
    <div style="background: #d1ecf1; padding: 1rem; border-radius: 4px; margin-top: 1rem;">
        <strong><i class="fas fa-brain"></i> Interpreta√ß√£o:</strong>
        Deficit significativo pode indicar problemas de mem√≥ria de trabalho, aten√ß√£o ou processamento auditivo.
    </div>
</div>

<script>
// Vari√°veis globais do Digit Span
let digitSpanData = {
    direct: { maxSpan: 0, totalCorrect: 0, trials: [], errors: 0 },
    reverse: { maxSpan: 0, totalCorrect: 0, trials: [], errors: 0 },
    currentPhase: 'direct',
    currentLength: 3,
    currentTrial: 1,
    currentSequence: [],
    trialsPerLength: 2,
    maxErrors: 2,
    isPlaying: false
};

// Sequ√™ncias pr√©-definidas para consist√™ncia
const digitSequences = {
    3: [
        [2, 1, 3], [5, 8, 2], [6, 9, 4], [7, 2, 8]
    ],
    4: [
        [6, 4, 3, 9], [7, 2, 8, 6], [4, 2, 7, 3], [8, 1, 5, 4]
    ],
    5: [
        [4, 2, 7, 3, 1], [7, 5, 8, 3, 6], [6, 1, 9, 4, 7], [3, 9, 2, 4, 8]
    ],
    6: [
        [6, 1, 9, 7, 4, 2], [3, 9, 2, 4, 8, 7], [5, 9, 1, 7, 4, 2], [4, 1, 7, 9, 3, 8]
    ],
    7: [
        [5, 8, 1, 3, 2, 6, 4], [3, 8, 2, 9, 6, 1, 7], [2, 7, 5, 8, 6, 2, 5], [8, 1, 2, 9, 3, 6, 5]
    ],
    8: [
        [9, 4, 3, 7, 6, 2, 5, 8], [7, 2, 8, 1, 9, 6, 5, 3], [5, 3, 9, 4, 1, 8, 6, 2], [4, 1, 7, 9, 2, 8, 5, 6]
    ],
    9: [
        [3, 9, 8, 1, 2, 5, 4, 7, 6], [6, 4, 8, 9, 1, 7, 2, 3, 5], [1, 5, 2, 8, 6, 9, 7, 4, 3], [7, 9, 6, 4, 8, 3, 1, 5, 2]
    ]
};

function showTestInterface() {
    document.getElementById('instructionsCard').style.display = 'none';
    document.getElementById('testInterface').style.display = 'block';
}

function startDigitSpan() {
    document.getElementById('startBtn').style.display = 'none';
    document.getElementById('playBtn').style.display = 'inline-block';
    document.getElementById('digitInput').disabled = false;
    
    updateTrialInfo();
    generateSequence();
}

function generateSequence() {
    const sequences = digitSequences[digitSpanData.currentLength];
    const trialIndex = (digitSpanData.currentTrial - 1) % sequences.length;
    digitSpanData.currentSequence = sequences[trialIndex];
    
    document.getElementById('sequenceDisplay').textContent = 'Sequ√™ncia preparada. Clique em "Reproduzir Sequ√™ncia"';
    document.getElementById('digitInput').value = '';
    document.getElementById('feedback').textContent = '';
}

function playSequence() {
    if (digitSpanData.isPlaying) return;
    
    digitSpanData.isPlaying = true;
    document.getElementById('playBtn').disabled = true;
    document.getElementById('submitBtn').style.display = 'inline-block';
    
    const sequence = digitSpanData.currentSequence;
    const display = document.getElementById('sequenceDisplay');
    
    display.textContent = 'Ou√ßa com aten√ß√£o...';
    
    let index = 0;
    const interval = setInterval(() => {
        if (index < sequence.length) {
            display.textContent = sequence[index];
            // S√≠ntese de voz se dispon√≠vel
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(sequence[index].toString());
                utterance.rate = 0.8;
                utterance.volume = 0.7;
                speechSynthesis.speak(utterance);
            }
            index++;
        } else {
            clearInterval(interval);
            display.textContent = 'Digite os n√∫meros separados por espa√ßo';
            document.getElementById('digitInput').focus();
            document.getElementById('playBtn').disabled = false;
            digitSpanData.isPlaying = false;
        }
    }, 1000);
}

function submitAnswer() {
    const input = document.getElementById('digitInput').value.trim();
    const userSequence = input.split(/\s+/).map(num => parseInt(num)).filter(num => !isNaN(num));
    
    let expectedSequence;
    if (digitSpanData.currentPhase === 'direct') {
        expectedSequence = digitSpanData.currentSequence;
    } else {
        expectedSequence = [...digitSpanData.currentSequence].reverse();
    }
    
    const isCorrect = arraysEqual(userSequence, expectedSequence);
    
    // Registrar resultado
    const phase = digitSpanData.currentPhase;
    digitSpanData[phase].trials.push({
        length: digitSpanData.currentLength,
        trial: digitSpanData.currentTrial,
        sequence: digitSpanData.currentSequence,
        expected: expectedSequence,
        answer: userSequence,
        correct: isCorrect
    });
    
    if (isCorrect) {
        digitSpanData[phase].totalCorrect++;
        digitSpanData[phase].maxSpan = Math.max(digitSpanData[phase].maxSpan, digitSpanData.currentLength);
        digitSpanData[phase].errors = 0; // Reset errors on correct answer
        showFeedback('‚úÖ Correto!', '#27ae60');
    } else {
        digitSpanData[phase].errors++;
        showFeedback(`‚ùå Incorreto. Esperado: ${expectedSequence.join(' ')}`, '#e74c3c');
    }
    
    document.getElementById('submitBtn').style.display = 'none';
    document.getElementById('nextBtn').style.display = 'inline-block';
}

function nextTrial() {
    document.getElementById('nextBtn').style.display = 'none';
    document.getElementById('playBtn').style.display = 'inline-block';
    
    const phase = digitSpanData.currentPhase;
    
    // Verificar se deve continuar
    if (digitSpanData[phase].errors >= digitSpanData.maxErrors) {
        // Muitas falhas consecutivas, encerrar fase
        if (digitSpanData.currentPhase === 'direct') {
            document.getElementById('reverseBtn').style.display = 'inline-block';
            document.getElementById('playBtn').style.display = 'none';
            document.getElementById('instructionText').textContent = 'Fase direta conclu√≠da. Clique em "Ordem Reversa" para continuar.';
        } else {
            finishDigitSpan();
        }
        return;
    }
    
    digitSpanData.currentTrial++;
    
    // Se completou 2 tentativas no comprimento atual, avan√ßar
    if (digitSpanData.currentTrial > digitSpanData.trialsPerLength) {
        digitSpanData.currentLength++;
        digitSpanData.currentTrial = 1;
        
        // Verificar se atingiu o limite m√°ximo
        if (digitSpanData.currentLength > 9) {
            if (digitSpanData.currentPhase === 'direct') {
                document.getElementById('reverseBtn').style.display = 'inline-block';
                document.getElementById('playBtn').style.display = 'none';
                document.getElementById('instructionText').textContent = 'Fase direta conclu√≠da. Clique em "Ordem Reversa" para continuar.';
            } else {
                finishDigitSpan();
            }
            return;
        }
    }
    
    updateTrialInfo();
    generateSequence();
}

function startReverse() {
    digitSpanData.currentPhase = 'reverse';
    digitSpanData.currentLength = 2;
    digitSpanData.currentTrial = 1;
    
    document.getElementById('reverseBtn').style.display = 'none';
    document.getElementById('playBtn').style.display = 'inline-block';
    document.getElementById('currentTest').textContent = 'Digit Span - Ordem Reversa';
    document.getElementById('instructionText').textContent = 'Agora repita os n√∫meros na ordem INVERSA';
    
    updateTrialInfo();
    generateSequence();
}

function finishDigitSpan() {
    // Atualizar campos do formul√°rio
    document.getElementById('direct_span').value = digitSpanData.direct.maxSpan;
    document.getElementById('direct_total').value = digitSpanData.direct.totalCorrect;
    document.getElementById('reverse_span').value = digitSpanData.reverse.maxSpan;
    document.getElementById('reverse_total').value = digitSpanData.reverse.totalCorrect;
    
    document.getElementById('testInterface').style.display = 'none';
    document.getElementById('resultsForm').style.display = 'block';
}

function updateTrialInfo() {
    const info = `${digitSpanData.currentPhase === 'direct' ? 'Direta' : 'Reversa'} - ` +
                 `Comprimento: ${digitSpanData.currentLength} - ` +
                 `Tentativa: ${digitSpanData.currentTrial}/${digitSpanData.trialsPerLength}`;
    document.getElementById('trialInfo').textContent = info;
}

function showFeedback(message, color) {
    const feedback = document.getElementById('feedback');
    feedback.textContent = message;
    feedback.style.color = color;
}

function arraysEqual(a, b) {
    return a.length === b.length && a.every((val, index) => val === b[index]);
}
</script>
{% endblock %}
