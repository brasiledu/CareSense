{% extends 'base.html' %}

{% block title %}Trail Making Test - {{ assessment.patient.full_name }} - CareSense{% endblock %}

{% block content %}
<div class="card">
    <h1><i class="fas fa-route"></i> Trail Making Test (TMT)</h1>
    <div style="background: #e8f4f8; padding: 1rem; border-radius: 4px; margin: 1rem 0;">
        <strong><i class="fas fa-user"></i> Paciente:</strong> {{ assessment.patient.full_name }} ({{ assessment.patient.age }} anos)<br>
        <strong><i class="fas fa-target"></i> Teste:</strong> Avaliação da atenção e flexibilidade cognitiva
    </div>
</div>

<!-- Interface do Teste Interativo -->
<div id="testInterface" class="card" style="display: none;">
    <div id="testHeader" style="text-align: center; margin-bottom: 2rem;">
        <h2 id="currentTest">TMT Parte A</h2>
        <div id="timerDisplay" style="font-size: 2rem; font-weight: bold; color: #2c3e50; margin: 1rem 0;">
            <i class="fas fa-stopwatch"></i> 00:00
        </div>
        <div id="instructionText" style="background: #e8f4f8; padding: 1rem; border-radius: 4px; margin: 1rem 0;">
            Conecte os números de 1 a 25 em ordem crescente. Clique em INICIAR quando estiver pronto.
        </div>
    </div>

    <!-- Canvas para desenhar os pontos TMT -->
    <div id="tmtCanvas" style="position: relative; width: 100%; height: 500px; border: 2px solid #3498db; border-radius: 8px; background: white; margin: 1rem 0;">
        <!-- Os pontos serão gerados aqui pelo JavaScript -->
    </div>

    <div id="testControls" style="text-align: center; margin: 2rem 0;">
        <button id="startBtn" onclick="startTMT()" class="btn btn-success" style="font-size: 1.2rem; padding: 1rem 2rem;">
            ▶️ INICIAR TESTE
        </button>
        <button id="resetBtn" onclick="resetTMT()" class="btn" style="display: none; margin-left: 1rem;">
            <i class="fas fa-redo"></i> Reiniciar
        </button>
        <button id="nextPartBtn" onclick="startPartB()" class="btn btn-primary" style="display: none; margin-left: 1rem;">
            ➡️ Parte B
        </button>
        <button id="finishBtn" onclick="finishTMT()" class="btn btn-success" style="display: none; margin-left: 1rem;">
            Finalizar
        </button>
    </div>

    <div id="errorDisplay" style="text-align: center; color: #e74c3c; font-weight: bold; margin: 1rem 0;"></div>
</div>

<!-- Instruções Iniciais -->
<div id="instructionsCard" class="card">
    <h2><i class="fas fa-info-circle"></i> Instruções</h2>
    <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 4px; margin-bottom: 2rem;">
        <h4>TMT Parte A:</h4>
        <p>O paciente deve conectar números de 1 a 25 em ordem crescente o mais rápido possível.</p>
        <p style="font-family: monospace; background: white; padding: 0.5rem; border-radius: 4px;">1 → 2 → 3 → 4 → 5 ... → 25</p>
        
        <h4 style="margin-top: 1.5rem;">TMT Parte B:</h4>
        <p>O paciente deve alternar entre números e letras em ordem crescente.</p>
        <p style="font-family: monospace; background: white; padding: 0.5rem; border-radius: 4px;">1 → A → 2 → B → 3 → C → 4 → D ... → 13</p>
        
        <p style="color: #e67e22;"><strong>⚠️ Importante:</strong> Cronometrar cada parte separadamente e anotar os erros.</p>
    </div>
    
    <div style="text-align: center;">
        <button onclick="showTestInterface()" class="btn btn-primary" style="font-size: 1.2rem; padding: 1rem 2rem;">
            <i class="fas fa-rocket"></i> Começar Teste Interativo
        </button>
    </div>
</div>

<!-- Formulário de Resultados -->
<form method="POST" id="resultsForm" class="card" style="display: none;">
    {% csrf_token %}
    <h2><i class="fas fa-save"></i> Resultados do Teste</h2>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin: 2rem 0;">
        <!-- TMT Parte A -->
        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px;">
            <h3><i class="fas fa-stopwatch"></i> TMT Parte A</h3>
            
            <div style="margin: 1rem 0;">
                <label for="time_a" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                    <i class="fas fa-clock"></i> Tempo (segundos):
                </label>
                <input type="number" id="time_a" name="time_a" min="10" max="300" step="0.1" required
                       style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;" readonly>
                <small style="color: #666;">Tempo registrado automaticamente</small>
            </div>
            
            <div style="margin: 1rem 0;">
                <label for="errors_a" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                    <i class="fas fa-exclamation-triangle"></i> Número de Erros:
                </label>
                <input type="number" id="errors_a" name="errors_a" min="0" max="20" value="0" required
                       style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;" readonly>
                <small style="color: #666;">Erros registrados automaticamente</small>
            </div>
        </div>

        <!-- TMT Parte B -->
        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px;">
            <h3><i class="fas fa-stopwatch"></i> TMT Parte B</h3>
            
            <div style="margin: 1rem 0;">
                <label for="time_b" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                    <i class="fas fa-clock"></i> Tempo (segundos):
                </label>
                <input type="number" id="time_b" name="time_b" min="20" max="600" step="0.1" required
                       style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;" readonly>
                <small style="color: #666;">Tempo registrado automaticamente</small>
            </div>
            
            <div style="margin: 1rem 0;">
                <label for="errors_b" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                    <i class="fas fa-exclamation-triangle"></i> Número de Erros:
                </label>
                <input type="number" id="errors_b" name="errors_b" min="0" max="20" value="0" required
                       style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;" readonly>
                <small style="color: #666;">Erros registrados automaticamente</small>
            </div>
        </div>
    </div>

    <div style="margin: 2rem 0; text-align: center;">
        <button type="submit" class="btn btn-success" style="font-size: 1.1rem; padding: 1rem 2rem;">
            <i class="fas fa-save"></i> Salvar Resultados
        </button>
        <a href="{% url 'run_tests' assessment.id %}" class="btn" style="margin-left: 1rem;">
            <i class="fas fa-arrow-left"></i> Voltar aos Testes
        </a>
    </div>
</form>

<div class="card">
    <h2><i class="fas fa-ruler"></i> Valores de Referência</h2>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
        <div>
            <h4>TMT Parte A - Tempos Normais:</h4>
            <ul style="line-height: 1.8;">
                <li><strong>18-39 anos:</strong> 22-28 segundos</li>
                <li><strong>40-49 anos:</strong> 28-33 segundos</li>
                <li><strong>50-59 anos:</strong> 32-40 segundos</li>
                <li><strong>60-69 anos:</strong> 38-50 segundos</li>
                <li><strong>70-79 anos:</strong> 45-65 segundos</li>
                <li><strong>80+ anos:</strong> 55-85 segundos</li>
            </ul>
        </div>
        <div>
            <h4>TMT Parte B - Tempos Normais:</h4>
            <ul style="line-height: 1.8;">
                <li><strong>18-39 anos:</strong> 50-75 segundos</li>
                <li><strong>40-49 anos:</strong> 60-85 segundos</li>
                <li><strong>50-59 anos:</strong> 70-100 segundos</li>
                <li><strong>60-69 anos:</strong> 85-120 segundos</li>
                <li><strong>70-79 anos:</strong> 100-155 segundos</li>
                <li><strong>80+ anos:</strong> 120-200 segundos</li>
            </ul>
        </div>
    </div>
    
    <div style="background: #fff3cd; padding: 1rem; border-radius: 4px; margin-top: 1rem;">
        <strong><i class="fas fa-lightbulb"></i> Dica de Aplicação:</strong>
        O teste interativo cronometra automaticamente e registra erros quando conexões incorretas são feitas.
    </div>
    
    <div style="background: #d1ecf1; padding: 1rem; border-radius: 4px; margin-top: 1rem;">
        <strong><i class="fas fa-brain"></i> Interpretação:</strong>
        Tempos muito elevados ou muitos erros podem indicar dificuldades de atenção, processamento visual-motor ou flexibilidade cognitiva.
    </div>
</div>

<script>
// Variáveis globais do TMT
let tmtData = {
    partA: { startTime: null, endTime: null, errors: 0, sequence: [], completed: false },
    partB: { startTime: null, endTime: null, errors: 0, sequence: [], completed: false },
    currentPart: 'A',
    currentTarget: 1,
    timer: null,
    points: {},
    connections: []
};

// Sequências TMT
const tmtSequences = {
    A: Array.from({length: 25}, (_, i) => i + 1),
    B: ['1', 'A', '2', 'B', '3', 'C', '4', 'D', '5', 'E', '6', 'F', '7', 'G', '8', 'H', '9', 'I', '10', 'J', '11', 'K', '12', 'L', '13']
};

function showTestInterface() {
    document.getElementById('instructionsCard').style.display = 'none';
    document.getElementById('testInterface').style.display = 'block';
    generateTMTPoints('A');
}

function generateTMTPoints(part) {
    const canvas = document.getElementById('tmtCanvas');
    canvas.innerHTML = '';
    tmtData.points = {};
    tmtData.connections = [];
    
    const sequence = tmtSequences[part];
    const containerRect = canvas.getBoundingClientRect();
    const width = canvas.offsetWidth - 60;
    const height = canvas.offsetHeight - 60;
    
    // Gerar posições aleatórias para os pontos
    const positions = [];
    const minDistance = 80;
    
    for (let i = 0; i < sequence.length; i++) {
        let x, y, attempts = 0;
        do {
            x = 30 + Math.random() * width;
            y = 30 + Math.random() * height;
            attempts++;
        } while (attempts < 100 && positions.some(pos => 
            Math.sqrt((pos.x - x)**2 + (pos.y - y)**2) < minDistance
        ));
        
        positions.push({x, y});
        
        // Criar elemento do ponto
        const point = document.createElement('div');
        point.id = `point-${sequence[i]}`;
        point.className = 'tmt-point';
        point.style.cssText = `
            position: absolute;
            left: ${x - 20}px;
            top: ${y - 20}px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #fff;
            border: 2px solid #3498db;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        `;
        point.textContent = sequence[i];
        point.onclick = () => clickPoint(sequence[i]);
        
        canvas.appendChild(point);
        tmtData.points[sequence[i]] = {element: point, x, y, connected: false};
    }
}

function startTMT() {
    const part = tmtData.currentPart;
    tmtData[`part${part}`].startTime = Date.now();
    tmtData[`part${part}`].errors = 0;
    tmtData.currentTarget = tmtData.currentPart === 'A' ? 1 : tmtSequences.B[0];
    
    document.getElementById('startBtn').style.display = 'none';
    document.getElementById('resetBtn').style.display = 'inline-block';
    document.getElementById('instructionText').textContent = 
        `Conecte em ordem: ${tmtSequences[tmtData.currentPart].join(' → ')}`;
    
    startTimer();
    highlightNextTarget();
}

function clickPoint(value) {
    if (!tmtData[`part${tmtData.currentPart}`].startTime) return;
    
    const sequence = tmtSequences[tmtData.currentPart];
    const expectedIndex = tmtData[`part${tmtData.currentPart}`].sequence.length;
    const expected = sequence[expectedIndex];
    
    if (value === expected) {
        // Conexão correta
        connectPoint(value);
        tmtData[`part${tmtData.currentPart}`].sequence.push(value);
        
        if (expectedIndex === sequence.length - 1) {
            // Parte completa
            completePart();
        } else {
            highlightNextTarget();
        }
    } else {
        // Erro
        tmtData[`part${tmtData.currentPart}`].errors++;
        showError(`Erro! Esperado: ${expected}, Clicado: ${value}`);
        updateErrorDisplay();
    }
}

function connectPoint(value) {
    const point = tmtData.points[value];
    point.element.style.background = '#27ae60';
    point.element.style.color = 'white';
    point.connected = true;
    
    // Desenhar linha se não for o primeiro ponto
    if (tmtData[`part${tmtData.currentPart}`].sequence.length > 0) {
        drawConnection();
    }
}

function drawConnection() {
    const sequence = tmtData[`part${tmtData.currentPart}`].sequence;
    if (sequence.length < 2) return;
    
    const from = sequence[sequence.length - 2];
    const to = sequence[sequence.length - 1];
    const fromPoint = tmtData.points[from];
    const toPoint = tmtData.points[to];
    
    const line = document.createElement('div');
    const dx = toPoint.x - fromPoint.x;
    const dy = toPoint.y - fromPoint.y;
    const length = Math.sqrt(dx*dx + dy*dy);
    const angle = Math.atan2(dy, dx) * 180 / Math.PI;
    
    line.style.cssText = `
        position: absolute;
        left: ${fromPoint.x}px;
        top: ${fromPoint.y - 1}px;
        width: ${length}px;
        height: 2px;
        background: #27ae60;
        transform-origin: 0 50%;
        transform: rotate(${angle}deg);
        z-index: 1;
    `;
    
    document.getElementById('tmtCanvas').appendChild(line);
}

function highlightNextTarget() {
    // Remover highlight anterior
    Object.values(tmtData.points).forEach(point => {
        if (!point.connected) {
            point.element.style.background = '#fff';
            point.element.style.borderColor = '#3498db';
        }
    });
    
    // Highlight próximo target
    const sequence = tmtSequences[tmtData.currentPart];
    const nextIndex = tmtData[`part${tmtData.currentPart}`].sequence.length;
    if (nextIndex < sequence.length) {
        const next = sequence[nextIndex];
        const nextPoint = tmtData.points[next];
        nextPoint.element.style.background = '#f39c12';
        nextPoint.element.style.borderColor = '#e67e22';
    }
}

function completePart() {
    const part = tmtData.currentPart;
    tmtData[`part${part}`].endTime = Date.now();
    tmtData[`part${part}`].completed = true;
    stopTimer();
    
    const time = (tmtData[`part${part}`].endTime - tmtData[`part${part}`].startTime) / 1000;
    const errors = tmtData[`part${part}`].errors;
    
    document.getElementById(`time_${part.toLowerCase()}`).value = time.toFixed(1);
    document.getElementById(`errors_${part.toLowerCase()}`).value = errors;
    
    showSuccess(`Parte ${part} concluída! Tempo: ${time.toFixed(1)}s, Erros: ${errors}`);
    
    if (part === 'A') {
        document.getElementById('nextPartBtn').style.display = 'inline-block';
        document.getElementById('resetBtn').style.display = 'none';
    } else {
        document.getElementById('finishBtn').style.display = 'inline-block';
        document.getElementById('resetBtn').style.display = 'none';
    }
}

function startPartB() {
    tmtData.currentPart = 'B';
    document.getElementById('currentTest').textContent = 'TMT Parte B';
    document.getElementById('instructionText').textContent = 
        'Alterne entre números e letras: 1 → A → 2 → B → 3 → C...';
    document.getElementById('nextPartBtn').style.display = 'none';
    document.getElementById('resetBtn').style.display = 'inline-block';
    generateTMTPoints('B');
    startTMT();
}

function finishTMT() {
    document.getElementById('testInterface').style.display = 'none';
    document.getElementById('resultsForm').style.display = 'block';
}

function resetTMT() {
    const part = tmtData.currentPart;
    stopTimer();
    tmtData[`part${part}`] = { startTime: null, endTime: null, errors: 0, sequence: [], completed: false };
    generateTMTPoints(part);
    document.getElementById('startBtn').style.display = 'inline-block';
    document.getElementById('resetBtn').style.display = 'none';
    document.getElementById('errorDisplay').textContent = '';
    updateTimerDisplay(0);
}

function startTimer() {
    tmtData.timer = setInterval(() => {
        const elapsed = (Date.now() - tmtData[`part${tmtData.currentPart}`].startTime) / 1000;
        updateTimerDisplay(elapsed);
    }, 100);
}

function stopTimer() {
    if (tmtData.timer) {
        clearInterval(tmtData.timer);
        tmtData.timer = null;
    }
}

function updateTimerDisplay(seconds) {
    const minutes = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    const centisecs = Math.floor((seconds % 1) * 100);
    document.getElementById('timerDisplay').textContent = 
        `⏱️ ${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}.${centisecs.toString().padStart(2, '0')}`;
}

function updateErrorDisplay() {
    const errors = tmtData[`part${tmtData.currentPart}`].errors;
    document.getElementById('errorDisplay').textContent = 
        errors > 0 ? `❌ Erros: ${errors}` : '';
}

function showError(message) {
    const errorDiv = document.getElementById('errorDisplay');
    errorDiv.textContent = message;
    errorDiv.style.color = '#e74c3c';
    setTimeout(() => {
        updateErrorDisplay();
    }, 2000);
}

function showSuccess(message) {
    const errorDiv = document.getElementById('errorDisplay');
    errorDiv.textContent = message;
    errorDiv.style.color = '#27ae60';
}

// Cleanup ao sair da página
window.addEventListener('beforeunload', () => {
    stopTimer();
});
</script>
{% endblock %}
