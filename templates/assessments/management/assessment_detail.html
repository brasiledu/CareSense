{% extends 'base.html' %}

{% block title %}Avaliação {{ assessment.id }} - AvivaMente{% endblock %}

{% block content %}
<style>
/* Estilos seguindo o padrão do projeto */
.assessment-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
}

/* Header da página */
.assessment-header {
    background: #2c3e50;
    color: white;
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
    text-align: center;
}

.assessment-title {
    font-size: 2rem;
    font-weight: 700;
    color: white;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
}

.assessment-subtitle {
    color: rgba(255, 255, 255, 0.8);
    font-size: 1rem;
    margin: 0;
}

/* Cards padrão */
.card {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
}

.card h2 {
    color: #2c3e50;
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* Info grid */
.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
    margin: 1.5rem 0;
}

.info-section h3 {
    color: #2c3e50;
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.info-section p {
    margin-bottom: 0.5rem;
    line-height: 1.6;
}

.info-section strong {
    color: #2c3e50;
    font-weight: 600;
}

/* Badges */
.badge {
    display: inline-block;
    padding: 0.3rem 0.8rem;
    font-size: 0.8rem;
    font-weight: 600;
    border-radius: 20px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.badge-pending {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffc107;
}

.badge-progress {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #17a2b8;
}

.badge-completed {
    background: #d4edda;
    color: #155724;
    border: 1px solid #28a745;
}

.badge-cancelled {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #dc3545;
}

/* Test results */
.test-result-card {
    border: 1px solid #e9ecef;
    border-radius: 12px;
    padding: 1.5rem;
    margin: 1rem 0;
    background: #f8f9fa;
}

.test-result-card h3 {
    color: #2c3e50;
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.test-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.test-metrics div {
    background: white;
    padding: 1rem;
    border-radius: 8px;
    border-left: 4px solid #007bff;
}

/* Z-scores */
.z-score-good { 
    color: #28a745; 
    font-weight: bold; 
    background: #d4edda;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
}

.z-score-warning { 
    color: #856404; 
    font-weight: bold; 
    background: #fff3cd;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
}

.z-score-danger { 
    color: #721c24; 
    font-weight: bold; 
    background: #f8d7da;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
}

/* Alert styles */
.alert {
    padding: 1rem;
    border-radius: 8px;
    margin: 1rem 0;
}

.alert-info {
    background: #d1ecf1;
    border: 1px solid #17a2b8;
    color: #0c5460;
}

/* Botões */
.btn {
    display: inline-block;
    padding: 0.75rem 1.5rem;
    background: #007bff;
    color: white;
    text-decoration: none;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
    transition: all 0.3s ease;
    margin: 0.25rem;
    text-align: center;
}

.btn:hover {
    background: #0056b3;
    transform: translateY(-1px);
    text-decoration: none;
    color: white;
}

.btn-warning {
    background: #ffc107;
    color: #212529;
}

.btn-warning:hover {
    background: #e0a800;
    color: #212529;
}

.btn i {
    margin-right: 0.5rem;
}

.actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

/* Responsividade */
@media (max-width: 768px) {
    .assessment-container {
        padding: 0 0.5rem;
    }
    
    .assessment-header {
        padding: 1.5rem;
    }
    
    .assessment-title {
        font-size: 1.7rem;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .info-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .test-metrics {
        grid-template-columns: 1fr;
    }
    
    .card {
        padding: 1.5rem;
    }
}

@media (max-width: 480px) {
    .assessment-header {
        padding: 1rem;
    }
    
    .assessment-title {
        font-size: 1.5rem;
    }
    
    .card {
        padding: 1rem;
    }
}
</style>

<div class="assessment-container">
    <!-- Header da página -->
    <div class="assessment-header">
        <h1 class="assessment-title">
            <i class="fas fa-clipboard-check"></i>
            Avaliação Neuropsicológica
        </h1>
        <p class="assessment-subtitle">ID #{{ assessment.id }} • Status: {{ assessment.get_status_display }}</p>
    </div>

    <!-- Informações da Avaliação -->
    <div class="card">
        <h2><i class="fas fa-info-circle"></i> Informações da Avaliação</h2>
        
        <div class="info-grid">
            <div class="info-section">
                <h3><i class="fas fa-user"></i> Informações do Paciente</h3>
                <p><strong>Nome:</strong> <a href="/patients/{{ assessment.patient.id }}/">{{ assessment.patient.full_name }}</a></p>
                <p><strong>Idade:</strong> {{ assessment.patient.age }} anos</p>
                <p><strong>Escolaridade:</strong> {{ assessment.patient.education_grade }}{% if assessment.patient.education_years %} ({{ assessment.patient.education_years }} anos){% endif %}</p>
                <p><strong>Quarto:</strong> {{ assessment.patient.room_number }}</p>
            </div>
            
            <div class="info-section">
                <h3><i class="fas fa-clipboard-list"></i> Dados da Avaliação</h3>
                <p><strong>Avaliador:</strong> {{ assessment.assessor.get_full_name }}</p>
                <p><strong>Status:</strong> 
                    {% if assessment.status == 'PENDING' %}
                        <span class="badge badge-pending">Pendente</span>
                    {% elif assessment.status == 'IN_PROGRESS' %}
                        <span class="badge badge-progress">Em Andamento</span>
                    {% elif assessment.status == 'COMPLETED' %}
                        <span class="badge badge-completed">Concluída</span>
                    {% else %}
                        <span class="badge badge-cancelled">Cancelada</span>
                    {% endif %}
                </p>
                <p><strong>Risco Cognitivo:</strong> 
                    {% if assessment.final_risk_score %}
                        {% if assessment.final_risk_score == 'LOW' %}
                            <span class="badge badge-completed">Baixo</span>
                        {% elif assessment.final_risk_score == 'MODERATE' %}
                            <span class="badge badge-pending">Moderado</span>
                        {% elif assessment.final_risk_score == 'HIGH' %}
                            <span class="badge badge-cancelled">Alto</span>
                        {% elif assessment.final_risk_score == 'CRITICAL' %}
                            <span class="badge" style="background: #dc3545; color: white;">Crítico</span>
                        {% endif %}
                    {% else %}
                        <span style="color: #6c757d;">Não avaliado</span>
                    {% endif %}
                </p>
                <p><strong>Criada em:</strong> {{ assessment.created_at|date:"d/m/Y H:i" }}</p>
                {% if assessment.completed_at %}
                <p><strong>Concluída em:</strong> {{ assessment.completed_at|date:"d/m/Y H:i" }}</p>
                {% endif %}
            </div>
        </div>
        
        <div class="actions-grid">
            <a href="/admin/assessments/assessment/{{ assessment.id }}/change/" class="btn btn-warning"><i class="fas fa-edit"></i> Editar Avaliação</a>
            <a href="/assessments/" class="btn"><i class="fas fa-arrow-left"></i> Voltar para Lista</a>
        </div>
    </div>

    <!-- Resultados dos Testes -->
    <div class="card">
        <h2><i class="fas fa-chart-line"></i> Resultados dos Testes Neuropsicológicos</h2>
        
        <!-- Teste Span de Dígitos -->
        <div class="test-result-card">
            <h3><i class="fas fa-sort-numeric-up"></i> Teste Span de Dígitos</h3>
            {% if digit_span %}
                <div class="test-metrics">
                    <div>
                        <p><strong>Pontuação Direta:</strong> {{ digit_span.forward_score }}</p>
                        <p><strong>Span Direto:</strong> {{ digit_span.forward_span }}</p>
                    </div>
                    <div>
                        <p><strong>Pontuação Inversa:</strong> {{ digit_span.backward_score }}</p>
                        <p><strong>Span Inverso:</strong> {{ digit_span.backward_span }}</p>
                    </div>
                    <div>
                        <p><strong>Pontuação Total:</strong> {{ digit_span.total_score }}</p>
                        {% if digit_span.z_score %}
                        <p><strong>Z-Score:</strong> 
                            <span class="z-score-{% if digit_span.z_score >= -1 %}good{% elif digit_span.z_score >= -2 %}warning{% else %}danger{% endif %}">
                                {{ digit_span.z_score|floatformat:2 }}
                            </span>
                        </p>
                        {% endif %}
                    </div>
                </div>
            {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Teste não realizado ainda. 
                    <a href="/admin/assessments/digitspanresult/add/?assessment={{ assessment.id }}" class="btn" style="margin-left: 1rem;"><i class="fas fa-plus"></i> Adicionar Resultado</a>
                </div>
            {% endif %}
        </div>
        
        <!-- Teste TMT -->
        <div class="test-result-card">
            <h3><i class="fas fa-target"></i> Trail Making Test (TMT)</h3>
            {% if tmt_result %}
                <div class="test-metrics">
                    <div>
                        <p><strong>TMT-A Tempo:</strong> {{ tmt_result.time_a_seconds|floatformat:1 }}s</p>
                        <p><strong>TMT-A Erros:</strong> {{ tmt_result.errors_a }}</p>
                        {% if tmt_result.z_score_a %}
                        <p><strong>TMT-A Z-Score:</strong> 
                            <span class="z-score-{% if tmt_result.z_score_a <= 1 %}good{% elif tmt_result.z_score_a <= 2 %}warning{% else %}danger{% endif %}">
                                {{ tmt_result.z_score_a|floatformat:2 }}
                            </span>
                        </p>
                        {% endif %}
                    </div>
                    <div>
                        <p><strong>TMT-B Tempo:</strong> {{ tmt_result.time_b_seconds|floatformat:1 }}s</p>
                        <p><strong>TMT-B Erros:</strong> {{ tmt_result.errors_b }}</p>
                        {% if tmt_result.z_score_b %}
                        <p><strong>TMT-B Z-Score:</strong> 
                            <span class="z-score-{% if tmt_result.z_score_b <= 1 %}good{% elif tmt_result.z_score_b <= 2 %}warning{% else %}danger{% endif %}">
                                {{ tmt_result.z_score_b|floatformat:2 }}
                            </span>
                        </p>
                        {% endif %}
                    </div>
                </div>
            {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Teste não realizado ainda. 
                    <a href="/admin/assessments/tmtresult/add/?assessment={{ assessment.id }}" class="btn" style="margin-left: 1rem;"><i class="fas fa-plus"></i> Adicionar Resultado</a>
                </div>
            {% endif %}
        </div>
        
        <!-- Teste Stroop -->
        <div class="test-result-card">
            <h3><i class="fas fa-palette"></i> Teste Stroop</h3>
            {% if stroop_result %}
                <div class="test-metrics">
                    <div>
                        <p><strong>Cartão 1 (Cores):</strong> {{ stroop_result.card_1_time|floatformat:1 }}s</p>
                        <p><strong>Erros Cartão 1:</strong> {{ stroop_result.card_1_errors }}</p>
                    </div>
                    <div>
                        <p><strong>Cartão 2 (Palavras):</strong> {{ stroop_result.card_2_time|floatformat:1 }}s</p>
                        <p><strong>Erros Cartão 2:</strong> {{ stroop_result.card_2_errors }}</p>
                    </div>
                    <div>
                        <p><strong>Cartão 3 (Cores/Palavras):</strong> {{ stroop_result.card_3_time|floatformat:1 }}s</p>
                        <p><strong>Erros Cartão 3:</strong> {{ stroop_result.card_3_errors }}</p>
                        {% if stroop_result.z_score %}
                        <p><strong>Z-Score:</strong> 
                            <span class="z-score-{% if stroop_result.z_score <= 1 %}good{% elif stroop_result.z_score <= 2 %}warning{% else %}danger{% endif %}">
                                {{ stroop_result.z_score|floatformat:2 }}
                            </span>
                        </p>
                        {% endif %}
                    </div>
                </div>
            {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Teste não realizado ainda. 
                    <a href="/admin/assessments/stroopresult/add/?assessment={{ assessment.id }}" class="btn" style="margin-left: 1rem;"><i class="fas fa-plus"></i> Adicionar Resultado</a>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Interpretação dos Resultados -->
    <div class="card">
        <h2><i class="fas fa-compass"></i> Interpretação dos Resultados</h2>
        
        {% if digit_span or tmt_result or stroop_result %}
            <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px;">
                <h4><i class="fas fa-clipboard-list"></i> Interpretação dos Z-Scores</h4>
                <div style="margin-top: 1rem;">
                    <p><strong>Para Digit Span (maior pontuação = melhor):</strong></p>
                    <ul>
                        <li><span style="color: green; font-weight: bold;">Verde (≥ -1.0):</span> Desempenho normal</li>
                        <li><span style="color: orange; font-weight: bold;">Laranja (-1.0 a -2.0):</span> Déficit leve a moderado</li>
                        <li><span style="color: red; font-weight: bold;">Vermelho (< -2.0):</span> Déficit severo</li>
                    </ul>
                    
                    <p><strong>Para TMT e Stroop (menor tempo = melhor):</strong></p>
                    <ul>
                        <li><span style="color: green; font-weight: bold;">Verde (≤ 1.0):</span> Desempenho normal</li>
                        <li><span style="color: orange; font-weight: bold;">Laranja (1.0 a 2.0):</span> Déficit leve a moderado</li>
                        <li><span style="color: red; font-weight: bold;">Vermelho (> 2.0):</span> Déficit severo</li>
                    </ul>
                </div>
            </div>
            
            {% if assessment.final_risk_score %}
                <div style="background: #e3f2fd; padding: 1.5rem; border-radius: 8px; margin-top: 1rem;">
                    <h4> Avaliação de Risco Cognitivo</h4>
                    <p style="font-size: 1.1rem; margin-top: 0.5rem;">
                        Com base nos resultados dos testes neuropsicológicos, o paciente apresenta 
                        <strong>risco {{ assessment.get_final_risk_score_display|lower }}</strong> para déficit cognitivo.
                    </p>
                </div>
            {% endif %}
        {% else %}
            <div class="alert alert-info">
                Nenhum teste foi realizado ainda. Complete os testes para obter uma interpretação dos resultados.
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}
