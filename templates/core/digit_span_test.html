{% extends 'base.html' %}

{% block title %}Teste Span de Dígitos - {{ assessment.patient.full_name }} - Avivamente{% endblock %}

{% block content %}
<div class="card">
    <h1><i class="fas fa-sort-numeric-up"></i> Teste Span de Dígitos</h1>
    <div style="background: #e8f4f8; padding: 1rem; border-radius: 4px; margin: 1rem 0;">
        <strong><i class="fas fa-user"></i> Paciente:</strong> {{ assessment.patient.full_name }} ({{ assessment.patient.age }} anos)<br>
        <strong><i class="fas fa-calendar"></i> Avaliação ID:</strong> {{ assessment.id }}
    </div>
</div>

<!-- Interface do Teste Interativo -->
<div id="test-interface" class="card">
    <h2><i class="fas fa-target"></i> Aplicação do Teste</h2>
    
    <!-- Controles do Teste -->
    <div id="test-controls" style="text-align: center; margin: 2rem 0;">
        <button id="start-test" class="btn btn-success" style="font-size: 1.2rem; padding: 1rem 2rem;">
             Iniciar Teste Span Direto
        </button>
    </div>
    
    <!-- Área de Apresentação -->
    <div id="presentation-area" style="display: none; text-align: center; margin: 2rem 0; min-height: 200px;">
        <h3 id="test-phase">Span Direto</h3>
        <div id="sequence-display" style="font-size: 4rem; font-weight: bold; color: #2c3e50; margin: 2rem 0; min-height: 100px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 8px;">
            Preparando...
        </div>
        <div id="instructions" style="font-size: 1.1rem; color: #7f8c8d; margin: 1rem 0;">
            <p>O paciente deve repetir os números na mesma ordem que aparecem</p>
        </div>
        <div id="test-buttons" style="margin-top: 2rem;">
            <button id="next-sequence" class="btn btn-success">✅ Acertou</button>
            <button id="wrong-sequence" class="btn btn-danger">❌ Errou</button>
            <button id="repeat-sequence" class="btn btn-warning"><i class="fas fa-redo"></i> Repetir</button>
        </div>
    </div>
    
    <!-- Progresso do Teste -->
    <div id="progress-area" style="display: none; margin: 2rem 0;">
        <h4> Progresso</h4>
        <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px;">
            <p><strong>Fase Atual:</strong> <span id="current-phase">Span Direto</span></p>
            <p><strong>Sequência Atual:</strong> <span id="current-sequence-length">2</span> dígitos</p>
            <p><strong>Tentativa:</strong> <span id="current-attempt">1</span> de 2</p>
            <p><strong>Acertos Consecutivos:</strong> <span id="consecutive-correct">0</span></p>
            <p><strong>Span Atual:</strong> <span id="current-span">1</span></p>
        </div>
    </div>
</div>

<!-- Formulário de Resultados -->
<div id="results-form" class="card" style="display: none;">
    <h2> Registrar Resultados</h2>
    
    <form method="POST">
        {% csrf_token %}
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div>
                <h3> Span Direto</h3>
                <div style="margin: 1rem 0;">
                    <label for="forward_score" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                        Pontuação Total (Forward):
                    </label>
                    <input type="number" name="forward_score" id="forward_score" min="0" max="16" required 
                           style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                    <small style="color: #7f8c8d;">Soma de todas as sequências corretas</small>
                </div>
                
                <div style="margin: 1rem 0;">
                    <label for="forward_span" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                        Span Máximo (Forward):
                    </label>
                    <input type="number" name="forward_span" id="forward_span" min="0" max="9" required 
                           style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                    <small style="color: #7f8c8d;">Maior sequência repetida corretamente</small>
                </div>
            </div>
            
            <div>
                <h3> Span Inverso</h3>
                <div style="margin: 1rem 0;">
                    <label for="backward_score" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                        Pontuação Total (Backward):
                    </label>
                    <input type="number" name="backward_score" id="backward_score" min="0" max="14" required 
                           style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                    <small style="color: #7f8c8d;">Soma de todas as sequências corretas</small>
                </div>
                
                <div style="margin: 1rem 0;">
                    <label for="backward_span" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                        Span Máximo (Backward):
                    </label>
                    <input type="number" name="backward_span" id="backward_span" min="0" max="8" required 
                           style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                    <small style="color: #7f8c8d;">Maior sequência repetida corretamente na ordem inversa</small>
                </div>
            </div>
        </div>
        
        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 4px; margin: 2rem 0;">
            <h4><i class="fas fa-lightbulb"></i> Pontuação Calculada Automaticamente</h4>
            <p><strong>Pontuação Total:</strong> <span id="total-score">0</span> pontos</p>
            <p><strong>Z-Score:</strong> <span id="z-score">Será calculado automaticamente</span></p>
        </div>
        
        <div style="margin: 2rem 0;">
            <button type="submit" class="btn btn-success" style="font-size: 1.1rem; padding: 1rem 2rem;">
                 Salvar Resultados
            </button>
            <a href="{% url 'run_tests' assessment.id %}" class="btn btn-warning" style="margin-left: 1rem;">
                ← Voltar aos Testes
            </a>
        </div>
    </form>
</div>

<!-- Instruções para o Avaliador -->
<div class="card">
    <h2> Instruções para o Avaliador</h2>
    <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 4px;">
        <h4> Como aplicar o teste:</h4>
        <ol style="margin-left: 2rem; line-height: 1.8;">
            <li><strong>Span Direto:</strong> Apresente as sequências de números e peça para o paciente repetir na mesma ordem</li>
            <li><strong>Span Inverso:</strong> Apresente as sequências e peça para o paciente repetir na ordem inversa</li>
            <li><strong>Critério de Parada:</strong> Pare quando o paciente errar 2 tentativas consecutivas do mesmo tamanho</li>
            <li><strong>Pontuação:</strong> 1 ponto para cada sequência correta</li>
        </ol>
        
        <h4 style="margin-top: 1.5rem;">⏱️ Sequências Padrão:</h4>
        <p><strong>2 dígitos:</strong> 5-8, 6-9</p>
        <p><strong>3 dígitos:</strong> 5-8-2, 6-9-4</p>
        <p><strong>4 dígitos:</strong> 6-4-3-9, 7-2-8-6</p>
        <p><strong>5 dígitos:</strong> 4-2-7-3-1, 7-5-8-3-6</p>
        <p><strong>6 dígitos:</strong> 6-1-9-4-7-3, 3-9-2-4-8-7</p>
        <p><strong>7 dígitos:</strong> 5-9-1-7-4-2-8, 4-1-7-9-3-8-6</p>
        <p><strong>8 dígitos:</strong> 5-8-1-9-2-6-4-7, 3-8-2-9-5-1-7-4</p>
        <p><strong>9 dígitos:</strong> 2-7-5-8-6-2-5-8-4, 7-1-3-9-4-2-5-6-8</p>
    </div>
</div>

<script>
class DigitSpanTest {
    constructor() {
        this.currentPhase = 'forward'; // 'forward' ou 'backward'
        this.sequenceLength = 2;
        this.attemptNumber = 1;
        this.consecutiveCorrect = 0;
        this.currentSpan = 1;
        this.forwardSpan = 0;
        this.backwardSpan = 0;
        this.forwardScore = 0;
        this.backwardScore = 0;
        this.consecutiveWrong = 0;
        
        // Sequências pré-definidas
        this.sequences = {
            forward: {
                2: ['5-8', '6-9'],
                3: ['5-8-2', '6-9-4'],
                4: ['6-4-3-9', '7-2-8-6'],
                5: ['4-2-7-3-1', '7-5-8-3-6'],
                6: ['6-1-9-4-7-3', '3-9-2-4-8-7'],
                7: ['5-9-1-7-4-2-8', '4-1-7-9-3-8-6'],
                8: ['5-8-1-9-2-6-4-7', '3-8-2-9-5-1-7-4'],
                9: ['2-7-5-8-6-2-5-8-4', '7-1-3-9-4-2-5-6-8']
            },
            backward: {
                2: ['2-4', '5-7'],
                3: ['6-2-9', '4-1-5'],
                4: ['3-2-7-9', '4-9-6-8'],
                5: ['1-5-2-8-6', '6-1-8-4-3'],
                6: ['5-3-9-4-1-8', '7-2-4-8-5-6'],
                7: ['8-1-2-9-3-6-5', '4-7-3-9-1-2-8'],
                8: ['9-4-3-7-6-2-5-8', '7-2-8-1-9-6-5-3']
            }
        };
        
        this.initializeEventListeners();
    }
    
    initializeEventListeners() {
        document.getElementById('start-test').addEventListener('click', () => this.startTest());
        document.getElementById('next-sequence').addEventListener('click', () => this.correctAnswer());
        document.getElementById('wrong-sequence').addEventListener('click', () => this.wrongAnswer());
        document.getElementById('repeat-sequence').addEventListener('click', () => this.repeatSequence());
        
        // Auto-calcular pontuação total
        ['forward_score', 'backward_score'].forEach(id => {
            document.getElementById(id).addEventListener('input', () => this.calculateTotalScore());
        });
    }
    
    startTest() {
        document.getElementById('test-controls').style.display = 'none';
        document.getElementById('presentation-area').style.display = 'block';
        document.getElementById('progress-area').style.display = 'block';
        
        this.presentSequence();
    }
    
    presentSequence() {
        this.updateProgress();
        
        const sequences = this.sequences[this.currentPhase][this.sequenceLength];
        if (!sequences || this.attemptNumber > sequences.length) {
            this.moveToNextLength();
            return;
        }
        
        const sequence = sequences[this.attemptNumber - 1];
        
        // Apresentar sequência
        this.showSequence(sequence);
    }
    
    showSequence(sequence) {
        const display = document.getElementById('sequence-display');
        const instructions = document.getElementById('instructions');
        
        if (this.currentPhase === 'forward') {
            instructions.innerHTML = '<p>O paciente deve repetir os números na <strong>mesma ordem</strong></p>';
        } else {
            instructions.innerHTML = '<p>O paciente deve repetir os números na <strong>ordem inversa</strong></p>';
        }
        
        const digits = sequence.split('-');
        display.textContent = 'Preparando...';
        
        setTimeout(() => {
            // Mostrar cada dígito por 1 segundo
            let index = 0;
            const showDigit = () => {
                if (index < digits.length) {
                    display.textContent = digits[index];
                    index++;
                    setTimeout(showDigit, 1000);
                } else {
                    display.textContent = 'Aguardando resposta...';
                }
            };
            showDigit();
        }, 1000);
    }
    
    correctAnswer() {
        this.consecutiveCorrect++;
        this.consecutiveWrong = 0;
        
        if (this.currentPhase === 'forward') {
            this.forwardScore++;
            this.forwardSpan = Math.max(this.forwardSpan, this.sequenceLength);
        } else {
            this.backwardScore++;
            this.backwardSpan = Math.max(this.backwardSpan, this.sequenceLength);
        }
        
        this.attemptNumber++;
        this.presentSequence();
    }
    
    wrongAnswer() {
        this.consecutiveCorrect = 0;
        this.consecutiveWrong++;
        
        this.attemptNumber++;
        
        // Se errou 2 tentativas consecutivas do mesmo tamanho, passar para próximo
        if (this.consecutiveWrong >= 2) {
            this.moveToNextLength();
        } else {
            this.presentSequence();
        }
    }
    
    moveToNextLength() {
        this.consecutiveWrong = 0;
        this.attemptNumber = 1;
        this.sequenceLength++;
        
        // Verificar se deve mudar de fase ou terminar
        if (this.currentPhase === 'forward' && this.sequenceLength > 9) {
            this.currentPhase = 'backward';
            this.sequenceLength = 2;
            document.getElementById('current-phase').textContent = 'Span Inverso';
            this.presentSequence();
        } else if (this.currentPhase === 'backward' && this.sequenceLength > 8) {
            this.finishTest();
        } else {
            this.presentSequence();
        }
    }
    
    finishTest() {
        document.getElementById('presentation-area').style.display = 'none';
        document.getElementById('progress-area').style.display = 'none';
        document.getElementById('results-form').style.display = 'block';
        
        // Preencher resultados automaticamente
        document.getElementById('forward_score').value = this.forwardScore;
        document.getElementById('forward_span').value = this.forwardSpan;
        document.getElementById('backward_score').value = this.backwardScore;
        document.getElementById('backward_span').value = this.backwardSpan;
        
        this.calculateTotalScore();
    }
    
    repeatSequence() {
        this.presentSequence();
    }
    
    updateProgress() {
        document.getElementById('current-phase').textContent = this.currentPhase === 'forward' ? 'Span Direto' : 'Span Inverso';
        document.getElementById('current-sequence-length').textContent = this.sequenceLength;
        document.getElementById('current-attempt').textContent = this.attemptNumber;
        document.getElementById('consecutive-correct').textContent = this.consecutiveCorrect;
        document.getElementById('current-span').textContent = this.currentPhase === 'forward' ? this.forwardSpan : this.backwardSpan;
    }
    
    calculateTotalScore() {
        const forwardScore = parseInt(document.getElementById('forward_score').value) || 0;
        const backwardScore = parseInt(document.getElementById('backward_score').value) || 0;
        const totalScore = forwardScore + backwardScore;
        
        document.getElementById('total-score').textContent = totalScore;
    }
}

// Inicializar teste quando a página carregar
document.addEventListener('DOMContentLoaded', function() {
    new DigitSpanTest();
});
</script>

<style>
.test-card {
    transition: all 0.3s ease;
}

.test-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

#sequence-display {
    transition: all 0.5s ease;
}

.btn {
    transition: all 0.3s ease;
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}
</style>
{% endblock %}