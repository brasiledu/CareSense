{% extends 'base.html' %}

{% block title %}Histórico - {{ patient.full_name }} - CareSense{% endblock %}

{% block content %}
<style>
/* Estilos para o dashboard do paciente */
.patient-header {
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    color: white;
    padding: 2rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    position: relative;
    overflow: hidden;
}

.patient-header::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 200px;
    height: 100%;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="2"/></svg>');
    opacity: 0.3;
}

.patient-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-top: 1rem;
}

.info-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.info-item i {
    font-size: 1.2rem;
    opacity: 0.8;
}

.stats-overview {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border-left: 4px solid;
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-3px);
}

.stat-card.total {
    border-left-color: #3498db;
}

.stat-card.completed {
    border-left-color: #27ae60;
}

.stat-card.pending {
    border-left-color: #f39c12;
}

.stat-card.risk {
    border-left-color: #e74c3c;
}

.stat-value {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.stat-label {
    color: #6c757d;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-trend {
    margin-top: 0.5rem;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.trend-improving {
    color: #27ae60;
}

.trend-worsening {
    color: #e74c3c;
}

.trend-stable {
    color: #6c757d;
}

.card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
    overflow: hidden;
}

.card-header {
    background: #f8f9fa;
    padding: 1.5rem;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.card-header h2 {
    margin: 0;
    color: #2c3e50;
    font-size: 1.3rem;
}

.card-body {
    padding: 1.5rem;
}

.chart-container {
    position: relative;
    height: 400px;
    margin: 1rem 0;
}

.assessments-timeline {
    margin-top: 2rem;
}

.timeline-item {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    padding: 1rem 0;
    border-bottom: 1px solid #e9ecef;
    transition: all 0.3s ease;
}

.timeline-item:hover {
    background-color: #f8f9fa;
    margin: 0 -1rem;
    padding-left: 1rem;
    padding-right: 1rem;
    border-radius: 8px;
}

.timeline-item:last-child {
    border-bottom: none;
}

.timeline-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.1rem;
    flex-shrink: 0;
}

.timeline-icon.completed {
    background: #27ae60;
}

.timeline-icon.pending {
    background: #f39c12;
}

.timeline-icon.in-progress {
    background: #3498db;
}

.timeline-content {
    flex: 1;
}

.timeline-title {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 0.25rem;
}

.timeline-meta {
    color: #6c757d;
    font-size: 0.85rem;
    margin-bottom: 0.5rem;
}

.timeline-scores {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.score-badge {
    background: #e9ecef;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    color: #495057;
}

.risk-badge {
    padding: 0.3rem 0.6rem;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.risk-low {
    background: #d4edda;
    color: #155724;
}

.risk-moderate {
    background: #fff3cd;
    color: #856404;
}

.risk-high {
    background: #f8d7da;
    color: #721c24;
}

.risk-critical {
    background: #dc3545;
    color: white;
}

.back-button {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: #6c757d;
    text-decoration: none;
    margin-bottom: 1rem;
    transition: color 0.3s ease;
}

.back-button:hover {
    color: #007bff;
    text-decoration: none;
}

/* Responsividade */
@media (max-width: 768px) {
    .patient-info {
        grid-template-columns: 1fr;
    }
    
    .stats-overview {
        grid-template-columns: 1fr;
    }
    
    .timeline-scores {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .chart-container {
        height: 300px;
    }
}
</style>

<a href="/patients/" class="back-button">
    <i class="fas fa-arrow-left"></i> Voltar à Lista de Pacientes
</a>

<!-- Cabeçalho do Paciente -->
<div class="patient-header">
    <h1><i class="fas fa-user"></i> {{ patient.full_name }}</h1>
    <div class="patient-info">
        <div class="info-item">
            <i class="fas fa-birthday-cake"></i>
            <span>{{ patient.age }} anos</span>
        </div>
        <div class="info-item">
            <i class="fas fa-graduation-cap"></i>
            <span>{{ patient.education_grade }}</span>
        </div>
        <div class="info-item">
            <i class="fas fa-bed"></i>
            <span>Quarto {{ patient.room_number }}</span>
        </div>
        <div class="info-item">
            <i class="fas fa-calendar"></i>
            <span>Cadastrado em {{ patient.created_at|date:"d/m/Y" }}</span>
        </div>
    </div>
</div>

<!-- Estatísticas Gerais -->
<div class="stats-overview">
    <div class="stat-card total">
        <div class="stat-value">{{ stats.total_assessments }}</div>
        <div class="stat-label">Total de Avaliações</div>
    </div>
    
    <div class="stat-card completed">
        <div class="stat-value">{{ stats.completed_assessments }}</div>
        <div class="stat-label">Avaliações Concluídas</div>
    </div>
    
    <div class="stat-card pending">
        <div class="stat-value">{{ stats.pending_assessments }}</div>
        <div class="stat-label">Avaliações Pendentes</div>
    </div>
    
    <div class="stat-card risk">
        <div class="stat-value">
            {% if stats.latest_risk %}
                {% if stats.latest_risk == 'LOW' %}Baixo
                {% elif stats.latest_risk == 'MODERATE' %}Moderado
                {% elif stats.latest_risk == 'HIGH' %}Alto
                {% elif stats.latest_risk == 'CRITICAL' %}Crítico
                {% else %}-{% endif %}
            {% else %}-{% endif %}
        </div>
        <div class="stat-label">Último Risco</div>
        <div class="stat-trend trend-{{ stats.risk_trend }}">
            {% if stats.risk_trend == 'improving' %}
                <i class="fas fa-arrow-down"></i> Melhorando
            {% elif stats.risk_trend == 'worsening' %}
                <i class="fas fa-arrow-up"></i> Piorando
            {% else %}
                <i class="fas fa-minus"></i> Estável
            {% endif %}
        </div>
    </div>
</div>

<!-- Gráficos de Evolução -->
{% if evolution_data.dates %}
<div class="card">
    <div class="card-header">
        <i class="fas fa-chart-line"></i>
        <h2>Evolução dos Z-Scores</h2>
    </div>
    <div class="card-body">
        <div class="chart-container">
            <canvas id="zScoreChart"></canvas>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <i class="fas fa-chart-bar"></i>
        <h2>Evolução das Pontuações Brutas</h2>
    </div>
    <div class="card-body">
        <div class="chart-container">
            <canvas id="rawScoreChart"></canvas>
        </div>
    </div>
</div>
{% endif %}

<!-- Histórico de Avaliações -->
<div class="card">
    <div class="card-header">
        <i class="fas fa-history"></i>
        <h2>Histórico de Avaliações</h2>
    </div>
    <div class="card-body">
        {% if assessments %}
            <div class="assessments-timeline">
                {% for assessment in assessments %}
                <div class="timeline-item">
                    <div class="timeline-icon {{ assessment.status|lower }}">
                        {% if assessment.status == 'COMPLETED' %}
                            <i class="fas fa-check"></i>
                        {% elif assessment.status == 'PENDING' %}
                            <i class="fas fa-clock"></i>
                        {% elif assessment.status == 'IN_PROGRESS' %}
                            <i class="fas fa-play"></i>
                        {% else %}
                            <i class="fas fa-times"></i>
                        {% endif %}
                    </div>
                    
                    <div class="timeline-content">
                        <div class="timeline-title">
                            <a href="/assessments/{{ assessment.id }}/" style="color: #2c3e50; text-decoration: none;">
                                Avaliação #{{ assessment.id }}
                            </a>
                            {% if assessment.final_risk_score %}
                                <span class="risk-badge risk-{{ assessment.final_risk_score|lower }}">
                                    {% if assessment.final_risk_score == 'LOW' %}Baixo Risco
                                    {% elif assessment.final_risk_score == 'MODERATE' %}Risco Moderado
                                    {% elif assessment.final_risk_score == 'HIGH' %}Alto Risco
                                    {% elif assessment.final_risk_score == 'CRITICAL' %}Risco Crítico
                                    {% endif %}
                                </span>
                            {% endif %}
                        </div>
                        
                        <div class="timeline-meta">
                            <i class="fas fa-calendar"></i> {{ assessment.created_at|date:"d/m/Y H:i" }}
                            <span style="margin-left: 1rem;">
                                <i class="fas fa-user-md"></i> {{ assessment.assessor.get_full_name }}
                            </span>
                            <span style="margin-left: 1rem;">
                                {% if assessment.status == 'COMPLETED' %}
                                    <i class="fas fa-check-circle" style="color: #27ae60;"></i> Concluída
                                {% elif assessment.status == 'PENDING' %}
                                    <i class="fas fa-clock" style="color: #f39c12;"></i> Pendente
                                {% elif assessment.status == 'IN_PROGRESS' %}
                                    <i class="fas fa-play" style="color: #3498db;"></i> Em Andamento
                                {% endif %}
                            </span>
                        </div>
                        
                        {% if assessment.status == 'COMPLETED' %}
                        <div class="timeline-scores">
                            {% if assessment.digit_span_result %}
                                <span class="score-badge">
                                    <i class="fas fa-sort-numeric-up"></i> 
                                    Digit Span: {{ assessment.digit_span_result.total_score|default:"-" }}
                                    {% if assessment.digit_span_result.z_score %}
                                        (Z: {{ assessment.digit_span_result.z_score|floatformat:2 }})
                                    {% endif %}
                                </span>
                            {% endif %}
                            
                            {% if assessment.tmt_result %}
                                <span class="score-badge">
                                    <i class="fas fa-route"></i> 
                                    TMT-A: {{ assessment.tmt_result.time_a|default:"-" }}s
                                    {% if assessment.tmt_result.z_score_a %}
                                        (Z: {{ assessment.tmt_result.z_score_a|floatformat:2 }})
                                    {% endif %}
                                </span>
                                <span class="score-badge">
                                    <i class="fas fa-route"></i> 
                                    TMT-B: {{ assessment.tmt_result.time_b|default:"-" }}s
                                    {% if assessment.tmt_result.z_score_b %}
                                        (Z: {{ assessment.tmt_result.z_score_b|floatformat:2 }})
                                    {% endif %}
                                </span>
                            {% endif %}
                            
                            {% if assessment.stroop_result %}
                                <span class="score-badge">
                                    <i class="fas fa-palette"></i> 
                                    Stroop: {{ assessment.stroop_result.interference_score|default:"-" }}
                                    {% if assessment.stroop_result.z_score %}
                                        (Z: {{ assessment.stroop_result.z_score|floatformat:2 }})
                                    {% endif %}
                                </span>
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        {% if assessment.status == 'PENDING' or assessment.status == 'IN_PROGRESS' %}
                        <div style="margin-top: 0.5rem;">
                            <a href="/assessments/{{ assessment.id }}/tests/" class="btn btn-primary btn-sm">
                                <i class="fas fa-play"></i> 
                                {% if assessment.status == 'PENDING' %}Iniciar Testes{% else %}Continuar Testes{% endif %}
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                Este paciente ainda não possui avaliações registradas.
                <a href="/admin/assessments/assessment/add/?patient={{ patient.id }}" class="btn btn-primary" style="margin-left: 1rem;">
                    <i class="fas fa-plus"></i> Criar Nova Avaliação
                </a>
            </div>
        {% endif %}
    </div>
</div>

<!-- Scripts para gráficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{% if evolution_data and evolution_data.dates %}
<!-- Dados para JavaScript -->
<script type="application/json" id="evolution-data">{{ evolution_data|safe }}</script>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Verificar se existem dados de evolução
    const evolutionDataElement = document.getElementById('evolution-data');
    if (!evolutionDataElement) {
        console.log('Dados de evolução não disponíveis para gráficos');
        return;
    }
    
    try {
        // Parse dos dados JSON
        let evolutionData;
        try {
            evolutionData = JSON.parse(evolutionDataElement.textContent);
        } catch (e) {
            console.error('Erro ao parsear dados de evolução:', e);
            return;
        }
        
        // Validação básica
        if (!evolutionData || !evolutionData.dates || !Array.isArray(evolutionData.dates)) {
            console.warn('Dados de evolução inválidos ou incompletos');
            return;
        }
        
        // Configuração comum dos gráficos
        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Data da Avaliação'
                    }
                }
            }
        };
        
        // Gráfico de Z-Scores
        const zScoreCtx = document.getElementById('zScoreChart');
        if (zScoreCtx) {
            try {
                new Chart(zScoreCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: evolutionData.dates || [],
                        datasets: [
                            {
                                label: 'Digit Span Z-Score',
                                data: evolutionData.digit_span_z_scores || [],
                                borderColor: '#3498db',
                                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                                tension: 0.2,
                                spanGaps: true
                            },
                            {
                                label: 'TMT-A Z-Score',
                                data: evolutionData.tmt_a_z_scores || [],
                                borderColor: '#e74c3c',
                                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                                tension: 0.2,
                                spanGaps: true
                            },
                            {
                                label: 'TMT-B Z-Score',
                                data: evolutionData.tmt_b_z_scores || [],
                                borderColor: '#f39c12',
                                backgroundColor: 'rgba(243, 156, 18, 0.1)',
                                tension: 0.2,
                                spanGaps: true
                            },
                            {
                                label: 'Stroop Z-Score',
                                data: evolutionData.stroop_z_scores || [],
                                borderColor: '#27ae60',
                                backgroundColor: 'rgba(39, 174, 96, 0.1)',
                                tension: 0.2,
                                spanGaps: true
                            }
                        ]
                    },
                    options: {
                        ...commonOptions,
                        scales: {
                            ...commonOptions.scales,
                            y: {
                                title: {
                                    display: true,
                                    text: 'Z-Score'
                                },
                                grid: {
                                    color: function(context) {
                                        if (Math.abs(context.tick.value) < 0.001) {
                                            return '#000';
                                        }
                                        return '#e0e0e0';
                                    },
                                    lineWidth: function(context) {
                                        if (Math.abs(context.tick.value) < 0.001) {
                                            return 2;
                                        }
                                        return 1;
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (e) {
                console.error('Erro ao criar gráfico Z-Score:', e);
            }
        }
        
        // Gráfico de Pontuações Brutas
        const rawScoreCtx = document.getElementById('rawScoreChart');
        if (rawScoreCtx) {
            try {
                new Chart(rawScoreCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: evolutionData.dates || [],
                        datasets: [
                            {
                                label: 'Digit Span Total',
                                data: evolutionData.digit_span_scores || [],
                                backgroundColor: 'rgba(52, 152, 219, 0.7)',
                                borderColor: '#3498db',
                                borderWidth: 1
                            },
                            {
                                label: 'TMT-A (segundos)',
                                data: evolutionData.tmt_a_times || [],
                                backgroundColor: 'rgba(231, 76, 60, 0.7)',
                                borderColor: '#e74c3c',
                                borderWidth: 1,
                                yAxisID: 'y1'
                            },
                            {
                                label: 'Stroop Interferência',
                                data: evolutionData.stroop_scores || [],
                                backgroundColor: 'rgba(39, 174, 96, 0.7)',
                                borderColor: '#27ae60',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        ...commonOptions,
                        scales: {
                            ...commonOptions.scales,
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Pontuações'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Tempo (segundos)'
                                },
                                grid: {
                                    drawOnChartArea: false,
                                }
                            }
                        }
                    }
                });
            } catch (e) {
                console.error('Erro ao criar gráfico de pontuações brutas:', e);
            }
        }
    } catch (e) {
        console.error('Erro geral na inicialização dos gráficos:', e);
    }
});
</script>
{% endblock %}
